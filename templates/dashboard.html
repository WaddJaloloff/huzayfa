<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <title>Lead Dashboard</title>
  <style>
    :root {
      --primary: #1a73e8;
      --bg: #f4f6f9;
      --white: #fff;
      --gray: #555;
      --light-gray: #f8f9fa;
      --shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    body {
      font-family: "Inter", sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 0;
    }

    header {
      background: var(--primary);
      color: var(--white);
      padding: 18px 28px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow);
    }

    header h2 {
      margin: 0;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    header a {
      color: var(--white);
      text-decoration: none;
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 16px;
      border-radius: 10px;
      transition: 0.3s;
      font-size: 15px;
    }

    header a:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .container {
      padding: 30px 40px;
    }

    /* Top bar (filter + stats) */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .top-bar h3 {
      font-size: 20px;
      color: #333;
      margin: 0;
    }

    #filterStatus {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 15px;
      background: var(--white);
      cursor: pointer;
      transition: 0.2s;
    }

    #filterStatus:hover {
      border-color: var(--primary);
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--white);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    th, td {
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: var(--light-gray);
      color: var(--gray);
      font-weight: 600;
    }

    tr:hover td {
      background: #f2f7ff;
    }

    select {
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      cursor: pointer;
      outline: none;
      transition: 0.2s;
    }

    /* Status ranglari */
    .status-boglanmadik {
      background: #e0e0e0;
      color: #0d47a1;
    }

    .status-bekor-qilindi {
      background: #fff3cd;
      color: #c62828;
    }

    .status-boglandik {
      background: #d4edda;
      color: #155724;
    }

    .comment {
      font-size: 14px;
      color: #444;
      border: none;
      background: transparent;
      width: 100%;
      outline: none;
      padding: 6px;
      border-radius: 6px;
      transition: 0.2s;
    }

    .comment:focus {
      background: #f1f5ff;
      border: 1px solid var(--primary);
    }

    footer {
      text-align: center;
      padding: 20px;
      color: #777;
      font-size: 14px;
      margin-top: 30px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      th, td {
        padding: 12px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h2>ðŸ“Š Leadlar paneli</h2>
    <a href="{{ url_for('logout') }}">Chiqish</a>
  </header>

  <div class="container">
    <div class="top-bar">
      <h3>Leadlar roâ€˜yxati</h3>
      <select id="filterStatus" onchange="filterLeads()">
        <option value="barchasi">Barchasi</option>
        <option value="bog'lanmadik">Bogâ€˜lanmadik</option>
        <option value="bekor qilindi">Bekor qilindi</option>
        <option value="bog'landik">Bogâ€˜landik</option>
      </select>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Ism</th>
          <th>Telefon</th>
          <th>Biznes</th>
          <th>Budjet</th>
          <th>Status</th>
          <th>Izoh</th>
          <th>Vaqt</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <footer>Â© 2025 Lead Admin Panel</footer>
<script>
  let editing = false;
  let allLeads = [];

  function colorize(select, value) {
    select.classList.remove("status-boglanmadik", "status-bekor-qilindi", "status-boglandik");
    if (value === "bog'lanmadik") select.classList.add("status-boglanmadik");
    if (value === "bekor qilindi") select.classList.add("status-bekor-qilindi");
    if (value === "bog'landik") select.classList.add("status-boglandik");
  }

  async function refreshData() {
    if (editing) return;
    const res = await fetch("/api/leads");
    const leads = await res.json();
    allLeads = leads;
    const selected = document.getElementById("filterStatus").value;
    renderLeads(selected === "barchasi" ? leads : leads.filter(l => l.status === selected));
  }

  function renderLeads(leads) {
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    leads.forEach((lead, i) => {
      const formatted = lead.created_at_formatted; // endi 05 November 2025, 23:21 koâ€˜rinadi

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${i + 1}</td>
        <td>${lead.name}</td>
        <td>${lead.phone}</td>
        <td>${lead.business}</td>
        <td>${lead.budget}</td>
        <td>
          <select onchange="changeStatus(${lead.id}, this)" data-id="${lead.id}">
            <option value="bog'lanmadik">bog'lanmadik</option>
            <option value="bekor qilindi">bekor qilindi</option>
            <option value="bog'landik">bog'landik</option>
          </select>
        </td>
        <td>
          <input class="comment" type="text"
            value="${lead.comment || ""}"
            onfocus="editing=true"
            onblur="editing=false; saveComment(${lead.id}, this.value)">
        </td>
        <td>${formatted}</td>
      `;
      tbody.appendChild(row);

      const select = row.querySelector("select");
      select.value = lead.status;
      colorize(select, lead.status);
    });
  }

  function filterLeads() {
    const selected = document.getElementById("filterStatus").value;
    if (selected === "barchasi") renderLeads(allLeads);
    else renderLeads(allLeads.filter(l => l.status === selected));
  }

  async function changeStatus(id, select) {
    const status = select.value;
    colorize(select, status);
    await fetch(`/update/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status })
    });
    refreshData();
  }

  async function saveComment(id, comment) {
    await fetch(`/update/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ comment })
    });
  }

  window.onload = refreshData;
  setInterval(refreshData, 10000);
</script>

</body>
</html>

